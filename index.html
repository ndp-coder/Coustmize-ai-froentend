<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor AI</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gemini-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .gemini-scrollbar::-webkit-scrollbar-track {
            background: #1e1f20;
        }
        .gemini-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4a4a4a;
            border-radius: 10px;
            border: 2px solid #1e1f20;
        }
        .gemini-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #6a6a6a;
        }
        .prose-styles h1, .prose-styles h2, .prose-styles h3 {
            color: #e5e7eb;
        }
        .prose-styles p, .prose-styles ul, .prose-styles ol, .prose-styles li {
            color: #d1d5db;
        }
        .prose-styles strong {
            color: #f9fafb;
        }
        .prose-styles code {
            background-color: #374151;
            color: #e5e7eb;
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
        }
        .prose-styles pre {
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .prose-styles pre code {
            background-color: transparent;
            padding: 0;
        }
        .loader {
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid #4f46e5;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chat-history-item.active {
            background-color: #374151;
        }
        .sidebar {
            transition: margin-left 0.3s ease-in-out;
        }
        .sidebar-hidden {
            margin-left: -16rem; /* Same as sidebar width */
        }
        .quiz-option-btn.correct {
            background-color: #16a34a !important;
            border-color: #166534 !important;
        }
        .quiz-option-btn.incorrect {
            background-color: #dc2626 !important;
            border-color: #991b1b !important;
        }
        /* Style for the auto-resizing textarea */
        #chat-input {
            max-height: 200px; /* Set a max height */
        }
    </style>
</head>
<body class="bg-[#131314] text-gray-200">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 bg-[#131314] flex items-center justify-center z-[100]">
        <div class="bg-[#1e1f20] p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-100 mb-6">Login</h2>
            <div id="auth-error" class="text-red-400 text-center text-sm mb-4 h-5"></div>
            <form id="auth-form" class="space-y-6">
                <input type="email" id="auth-email" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Email" required>
                <input type="password" id="auth-password" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Password" required>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">
                    Login
                </button>
            </form>
            <p class="text-center text-sm text-gray-400 mt-6">
                <span id="auth-prompt-text">Don't have an account?</span>
                <button id="auth-toggle-btn" class="font-semibold text-indigo-400 hover:text-indigo-500">Register</button>
            </p>
        </div>
    </div>
    
    <!-- Profile Creation Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-[#1e1f20] p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <h2 class="text-2xl font-bold text-center text-gray-100 mb-6">Create Your Profile</h2>
            <p class="text-center text-gray-400 mb-8">Select your details to personalize the AI. </p>
            <div class="space-y-6">
                <div>
                    <label for="user-name" class="block text-sm font-medium text-gray-300 mb-2">Name</label>
                    <input type="text" id="user-name" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Enter your name...">
                </div>
                <div>
                    <label for="user-age" class="block text-sm font-medium text-gray-300 mb-2">Age</label>
                    <input type="number" id="user-age" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Enter your age...">
                </div>
                <div>
                    <label for="class-group" class="block text-sm font-medium text-gray-300 mb-2">Class</label>
                    <select id="class-group" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="">Select a class...</option>
                        <option value="5">5th Class</option>
                        <option value="6">6th Class</option>
                        <option value="7">7th Class</option>
                        <option value="8">8th Class</option>
                        <option value="9">9th Class</option>
                        <option value="10">10th Class</option>
                        <option value="11">11th Class</option>
                        <option value="12">12th Class</option>
                    </select>
                </div>
                <div id="gender-selection" class="hidden">
                    <label for="gender" class="block text-sm font-medium text-gray-300 mb-2">Gender</label>
                    <select id="gender" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="">Select gender...</option>
                        <option value="Boy">Boy</option>
                        <option value="Girl">Girl</option>
                    </select>
                </div>
                <div id="stream-selection" class="hidden">
                    <label for="stream" class="block text-sm font-medium text-gray-300 mb-2">Stream</label>
                    <select id="stream" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="">Select stream...</option>
                        <option value="JEE">JEE (Engineering)</option>
                        <option value="NEET">NEET (Medical)</option>
                    </select>
                </div>
            </div>
            <button id="start-chatting-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mt-10 transition-colors duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed">
                Save Profile
            </button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-[#1e1f20] p-6 rounded-lg shadow-xl w-full max-w-sm border border-gray-700">
            <h3 id="confirm-title" class="text-lg font-bold text-white mb-4">Are you sure?</h3>
            <p id="confirm-text" class="text-gray-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold">Cancel</button>
                <button id="confirm-ok-btn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold">Delete</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-[#1e1f20] p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <h2 class="text-2xl font-bold text-center text-gray-100 mb-6">Settings</h2>
            <div class="space-y-6">
                 <div>
                    <label for="user-name-settings-input" class="block text-sm font-medium text-gray-300 mb-2">Your Name</label>
                    <input type="text" id="user-name-settings-input" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="What should the AI call you?">
                </div>
                 <div>
                    <label for="user-age-settings-input" class="block text-sm font-medium text-gray-300 mb-2">Your Age</label>
                    <input type="number" id="user-age-settings-input" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Enter your age">
                </div>
                <div>
                    <label for="class-group-settings" class="block text-sm font-medium text-gray-300 mb-2">Class</label>
                    <select id="class-group-settings" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="">Select a class...</option>
                        <option value="5">5th Class</option>
                        <option value="6">6th Class</option>
                        <option value="7">7th Class</option>
                        <option value="8">8th Class</option>
                        <option value="9">9th Class</option>
                        <option value="10">10th Class</option>
                        <option value="11">11th Class</option>
                        <option value="12">12th Class</option>
                    </select>
                </div>
                <div id="gender-selection-settings" class="hidden">
                    <label for="gender-settings" class="block text-sm font-medium text-gray-300 mb-2">Gender</label>
                    <select id="gender-settings" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="">Select gender...</option>
                        <option value="Boy">Boy</option>
                        <option value="Girl">Girl</option>
                    </select>
                </div>
                <div id="stream-selection-settings" class="hidden">
                    <label for="stream-settings" class="block text-sm font-medium text-gray-300 mb-2">Stream</label>
                    <select id="stream-settings" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="">Select stream...</option>
                        <option value="JEE">JEE (Engineering)</option>
                        <option value="NEET">NEET (Medical)</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-10">
                <button id="settings-close-btn" class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold">Close</button>
                <button id="settings-save-btn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">Save</button>
            </div>
        </div>
    </div>

    <!-- AI Tools Modal -->
    <div id="ai-tools-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-[#1e1f20] p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <h2 class="text-2xl font-bold text-center text-gray-100 mb-4">✨ AI Tools</h2>
            <p class="text-center text-gray-400 mb-8">Let's supercharge your learning.</p>
            <div class="space-y-4">
                <div id="ai-tool-options">
                    <button data-tool="planner" class="w-full text-left p-4 rounded-lg bg-[#2a2b2c] hover:bg-gray-600 transition-colors">
                        <h3 class="font-semibold text-lg text-white">Study Plan Generator</h3>
                        <p class="text-sm text-gray-400">Create a weekly study plan for any topic.</p>
                    </button>
                    <button data-tool="quiz" class="w-full text-left p-4 rounded-lg bg-[#2a2b2c] hover:bg-gray-600 transition-colors mt-4">
                        <h3 class="font-semibold text-lg text-white">Quiz Master</h3>
                        <p class="text-sm text-gray-400">Generate an interactive quiz on any subject.</p>
                    </button>
                </div>
                <div id="ai-tool-input-section" class="hidden">
                    <label for="ai-tool-topic-input" class="block text-sm font-medium text-gray-300 mb-2">Topic</label>
                    <input type="text" id="ai-tool-topic-input" class="w-full bg-[#2a2b2c] border border-gray-600 rounded-lg px-4 py-3 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="e.g., Photosynthesis, Trigonometry...">
                    <div class="flex justify-end gap-4 mt-6">
                         <button id="ai-tool-back-btn" class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold">Back</button>
                         <button id="ai-tool-generate-btn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">Generate</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Main Chat Interface -->
    <div id="main-content" class="flex h-screen hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-[#1e1f20] p-4 flex flex-col shrink-0 sidebar">
            <button id="new-chat-btn" class="flex items-center justify-between w-full bg-[#2a2b2c] hover:bg-gray-600 text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200 mb-4">
                <span>New Chat</span>
                <i data-lucide="plus"></i>
            </button>
            <div class="flex-grow overflow-y-auto gemini-scrollbar pr-2">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">History</p>
                <div id="chat-history-list" class="space-y-1"></div>
            </div>
            <div class="mt-auto p-2 bg-[#2a2b2c] rounded-lg shrink-0">
                <p class="text-sm font-semibold text-gray-100">User Profile</p>
                <p id="profile-display" class="text-xs text-gray-400 mt-1">Not logged in</p>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="flex-1 flex flex-col bg-[#131314]">
             <header class="p-4 flex items-center justify-between gap-4 border-b border-gray-800">
                <div class="flex items-center gap-4">
                     <button id="sidebar-toggle-btn" class="p-2 rounded-full hover:bg-gray-700">
                         <i data-lucide="menu"></i>
                     </button>
                     <h2 id="chat-title-header" class="text-lg font-medium">New Chat</h2>
                </div>
                 <div class="flex items-center gap-2">
                    <button id="settings-open-btn" class="p-2 rounded-full hover:bg-gray-700">
                        <i data-lucide="settings"></i>
                    </button>
                    <button id="logout-btn" class="p-2 rounded-full hover:bg-gray-700">
                        <i data-lucide="log-out"></i>
                    </button>
                </div>
            </header>
            <div id="chat-container" class="flex-1 overflow-y-auto p-6 md:p-10 gemini-scrollbar">
                <div id="chat-messages" class="max-w-4xl mx-auto">
                     <div class="text-center">
                         <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 text-transparent bg-clip-text mb-4">Welcome!</h1>
                         <p class="text-xl text-gray-400">Login or Register to start chatting.</p>
                    </div>
                </div>
            </div>

            <!-- Input Form -->
            <div class="p-4 md:p-6">
                <div class="max-w-4xl mx-auto">
                    <form id="chat-form" class="relative flex items-center gap-2">
                         <button type="button" id="ai-tools-open-btn" class="p-3 bg-[#1e1f20] hover:bg-gray-700 rounded-full text-white disabled:bg-gray-500 disabled:cursor-not-allowed">
                            <i data-lucide="sparkles"></i>
                        </button>
                        <textarea id="chat-input" class="w-full bg-[#1e1f20] border border-gray-700 rounded-2xl py-4 pl-6 pr-20 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200" placeholder="Message AI Chatbot..." rows="1" disabled></textarea>
                        <button type="submit" class="absolute bottom-3 right-3 bg-indigo-600 hover:bg-indigo-700 rounded-full p-3 text-white disabled:bg-gray-500 disabled:cursor-not-allowed">
                            <i data-lucide="arrow-up"></i>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const authScreen = document.getElementById('auth-screen');
            const mainContent = document.getElementById('main-content');
            const authForm = document.getElementById('auth-form');
            const authTitle = document.getElementById('auth-title');
            const authEmailInput = document.getElementById('auth-email');
            const authPasswordInput = document.getElementById('auth-password');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const authToggleBtn = document.getElementById('auth-toggle-btn');
            const authPromptText = document.getElementById('auth-prompt-text');
            const authError = document.getElementById('auth-error');
            const profileModal = document.getElementById('profile-modal');
            const userNameInput = document.getElementById('user-name');
            const userAgeInput = document.getElementById('user-age');
            const classGroupSelect = document.getElementById('class-group');
            const genderSelectionDiv = document.getElementById('gender-selection');
            const genderSelect = document.getElementById('gender');
            const streamSelectionDiv = document.getElementById('stream-selection');
            const streamSelect = document.getElementById('stream');
            const startChattingBtn = document.getElementById('start-chatting-btn');
            const settingsModal = document.getElementById('settings-modal');
            const settingsOpenBtn = document.getElementById('settings-open-btn');
            const settingsCloseBtn = document.getElementById('settings-close-btn');
            const settingsSaveBtn = document.getElementById('settings-save-btn');
            const userNameSettingsInput = document.getElementById('user-name-settings-input');
            const userAgeSettingsInput = document.getElementById('user-age-settings-input');
            const classGroupSettings = document.getElementById('class-group-settings');
            const genderSelectionSettings = document.getElementById('gender-selection-settings');
            const genderSettings = document.getElementById('gender-settings');
            const streamSelectionSettings = document.getElementById('stream-selection-settings');
            const streamSettings = document.getElementById('stream-settings');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            const profileDisplay = document.getElementById('profile-display');
            const chatHistoryList = document.getElementById('chat-history-list');
            const chatContainer = document.getElementById('chat-container');
            const chatMessages = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const newChatBtn = document.getElementById('new-chat-btn');
            const submitButton = chatForm.querySelector('button[type="submit"]');
            const chatTitleHeader = document.getElementById('chat-title-header');
            const logoutBtn = document.getElementById('logout-btn');
            const aiToolsModal = document.getElementById('ai-tools-modal');
            const aiToolsOpenBtn = document.getElementById('ai-tools-open-btn');
            const aiToolOptions = document.getElementById('ai-tool-options');
            const aiToolInputSection = document.getElementById('ai-tool-input-section');
            const aiToolTopicInput = document.getElementById('ai-tool-topic-input');
            const aiToolBackBtn = document.getElementById('ai-tool-back-btn');
            const aiToolGenerateBtn = document.getElementById('ai-tool-generate-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmText = document.getElementById('confirm-text');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            // --- State ---
            let isLoginMode = true;
            let userProfile = null;
            let allChats = [];
            let activeChat = null;
            let isLoading = false;
            let jwtToken = null; 
            let selectedAiTool = null;
            let onConfirmCallback = null;

            // --- API Configuration ---
            const API_BASE_URL = 'https://coustmize-ai-backend.onrender.com'; 

            // --- UI Logic ---
            function toggleAuthMode() {
                isLoginMode = !isLoginMode;
                authTitle.textContent = isLoginMode ? 'Login' : 'Register';
                authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Register';
                authPromptText.textContent = isLoginMode ? "Don't have an account?" : "Already have an account?";
                authToggleBtn.textContent = isLoginMode ? 'Register' : 'Login';
                authError.textContent = '';
            }

            async function showApp() {
                authScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                chatInput.disabled = false;
                
                await fetchUserProfile();
                if (!userProfile || !userProfile.name) {
                    profileModal.classList.remove('hidden');
                } else {
                    await fetchChats();
                    displayUserProfile();
                }
            }

            function showAuthScreen() {
                authScreen.classList.remove('hidden');
                mainContent.classList.add('hidden');
                userProfile = null;
                jwtToken = null;
                activeChat = null;
                allChats = [];
                localStorage.removeItem('authToken');
            }

            // --- Authentication & Profile Logic ---
            async function handleAuthSubmit(e) {
                e.preventDefault();
                const email = authEmailInput.value;
                const password = authPasswordInput.value;
                const endpoint = isLoginMode ? '/auth/login' : '/auth/register';
                
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'An error occurred.');

                    jwtToken = data.token; 
                    localStorage.setItem('authToken', jwtToken);
                    await showApp();

                } catch (error) {
                    authError.textContent = error.message;
                }
            }
            
            async function fetchUserProfile() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/profile`, {
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (!response.ok) throw new Error('Could not fetch profile.');
                    userProfile = await response.json();
                } catch (error) {
                    console.error("Profile fetch error:", error);
                    showAuthScreen(); // If we can't get profile, log out
                }
            }
            
            async function handleProfileSave(isFromSettings = false) {
                 const profileData = {
                    name: (isFromSettings ? userNameSettingsInput : userNameInput).value.trim(),
                    age: (isFromSettings ? userAgeSettingsInput : userAgeInput).value,
                    classValue: (isFromSettings ? classGroupSettings : classGroupSelect).value,
                    classGroup: (isFromSettings ? classGroupSettings : classGroupSelect).options[(isFromSettings ? classGroupSettings : classGroupSelect).selectedIndex].text,
                    gender: (isFromSettings ? genderSettings : genderSelect).value,
                    stream: (isFromSettings ? streamSettings : streamSelect).value,
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/api/profile`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}` 
                        },
                        body: JSON.stringify(profileData)
                    });
                    if (!response.ok) throw new Error('Failed to save profile.');
                    userProfile = profileData;
                    
                    if(isFromSettings) {
                        settingsModal.classList.add('hidden');
                    } else {
                        profileModal.classList.add('hidden');
                        await handleNewChat();
                    }
                    displayUserProfile();
                } catch(error) {
                    console.error("Profile save error:", error);
                }
            }

            function displayUserProfile() {
                if (userProfile && userProfile.name) {
                    let profileText = `${userProfile.name}, Age ${userProfile.age}, ${userProfile.classGroup}`;
                    if (userProfile.gender) profileText += `, ${userProfile.gender}`;
                    if (userProfile.stream) profileText += `, ${userProfile.stream}`;
                    profileDisplay.textContent = profileText;
                } else if (userProfile) {
                    profileDisplay.textContent = userProfile.email;
                }
            }
            
            // --- Chat Logic ---
            async function fetchChats() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chats`, {
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (!response.ok) throw new Error('Could not fetch chats.');
                    allChats = await response.json();
                    renderChatHistory();
                    if (allChats.length > 0) {
                        await handleSwitchChat(allChats[0].id);
                    } else {
                        await handleNewChat();
                    }
                } catch (error) {
                    console.error("Fetch chats error:", error);
                    await handleNewChat();
                }
            }

            async function handleNewChat() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chats/new`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (!response.ok) throw new Error('Could not create new chat.');
                    const newChat = await response.json();
                    allChats.unshift({id: newChat.id, title: newChat.title});
                    await handleSwitchChat(newChat.id);
                } catch (error) {
                    console.error("New chat error:", error);
                }
            }
            
            async function handleSwitchChat(chatId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chats/${chatId}`, {
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (!response.ok) throw new Error('Could not fetch chat details.');
                    activeChat = await response.json();
                    chatTitleHeader.textContent = activeChat.title;
                    renderChatHistory();
                    renderMessages();
                } catch (error) {
                    console.error("Switch chat error:", error);
                }
            }

            async function handleChatSubmit(e) {
                e.preventDefault();
                const prompt = chatInput.value.trim();
                if (!prompt || isLoading || !activeChat) return;

                if (activeChat.title === 'New Chat') {
                    activeChat.title = prompt;
                }

                activeChat.history.push({ role: 'user', parts: [{ text: prompt }] });
                renderMessages();
                chatInput.value = '';
                autosizeTextarea();
                
                toggleLoading(true);

                try {
                    const response = await fetch(`${API_BASE_URL}/api/gemini`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}`
                        },
                        body: JSON.stringify({ history: activeChat.history })
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.message || 'Failed to get response from AI.');
                    }

                    const data = await response.json();
                    activeChat.history.push({ role: 'model', parts: [{ text: data.text }] });

                    await fetch(`${API_BASE_URL}/api/chats/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}`
                        },
                        body: JSON.stringify({ chat: activeChat })
                    });
                    
                    const chatInList = allChats.find(c => c.id === activeChat.id);
                    if (chatInList) chatInList.title = activeChat.title;
                    renderChatHistory();

                } catch (error) {
                    console.error("Chat API Error:", error);
                    activeChat.history.push({ role: 'model', parts: [{ text: `An error occurred: ${error.message}` }] });
                } finally {
                    toggleLoading(false);
                    renderMessages();
                }
            }
            
             async function handleAiToolGeneration() {
                const topic = aiToolTopicInput.value.trim();
                if (!topic || !activeChat) return;
                
                aiToolsModal.classList.add('hidden');
                toggleLoading(true);
                
                let userMessage = '';
                if (selectedAiTool === 'planner') userMessage = `Generating a study plan for "${topic}"...`;
                else if (selectedAiTool === 'quiz') userMessage = `Generating a quiz for "${topic}"...`;
                
                activeChat.history.push({ role: 'user', parts: [{ text: userMessage }] });
                renderMessages();

                try {
                    const response = await fetch(`${API_BASE_URL}/api/gemini`, {
                         method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}`
                        },
                        body: JSON.stringify({ tool: selectedAiTool, topic: topic, profile: userProfile })
                    });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.message || 'Failed to get AI tool response.');
                    }
                    
                    const data = await response.json();

                    if (selectedAiTool === 'planner') {
                        activeChat.history.push({ role: 'model', parts: [{ text: data.text }] });
                    } else if (selectedAiTool === 'quiz') {
                        const quizData = JSON.parse(data.text);
                        activeChat.history.push({ role: 'model', parts: [{ text: quizData.quiz }], isQuiz: true, id: `msg-${Date.now()}` });
                    }
                    
                    await fetch(`${API_BASE_URL}/api/chats/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}`
                        },
                        body: JSON.stringify({ chat: activeChat })
                    });

                } catch(error) {
                    console.error("Failed to generate AI tool content:", error);
                    activeChat.history.push({ role: 'model', parts: [{ text: `An error occurred: ${error.message}.` }] });
                } finally {
                    toggleLoading(false);
                    renderMessages();
                }
            }


            function renderMessages() {
                chatMessages.innerHTML = '';
                if (!activeChat || activeChat.history.length === 0) {
                     if (userProfile?.name) {
                        chatMessages.innerHTML = `<div class="text-center"><h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 text-transparent bg-clip-text mb-4">Hello, ${userProfile.name}!</h1><p class="text-xl text-gray-400">How can I help you today?</p></div>`;
                     }
                     return;
                }

                activeChat.history.forEach(message => {
                    const isUser = message.role === 'user';
                    const avatarChar = isUser ? (userProfile.name.charAt(0).toUpperCase() || 'U') : 'AI';
                    const avatarBg = isUser ? 'bg-gray-600' : 'bg-gradient-to-tr from-indigo-500 to-purple-500';
                    let content;
                    if (isUser) {
                        content = message.parts[0].text;
                    } else if (message.isQuiz) {
                        content = renderQuiz(message.parts[0].text, message.id);
                    } else {
                        content = marked.parse(message.parts[0].text);
                    }
                    
                    const messageHtml = `
                        <div class="flex items-start gap-4 mb-6 max-w-4xl mx-auto">
                            <div class="w-8 h-8 rounded-full ${avatarBg} flex items-center justify-center text-white font-bold text-sm flex-shrink-0">${avatarChar}</div>
                            <div id="${message.id}" class="p-4 ${!isUser ? 'bg-[#1e1f20] rounded-b-xl rounded-tr-xl' : ''} flex-1 prose-styles">${content}</div>
                        </div>`;
                    chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                });
                attachQuizHandlers();
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function renderQuiz(quizData, messageId) {
                let quizHtml = `<div class="space-y-6" data-message-id="${messageId}">`;
                quizData.forEach((q, index) => {
                    quizHtml += `
                        <div class="quiz-question" data-question-index="${index}">
                            <p class="font-semibold">${index + 1}. ${q.question}</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-3">
                                ${q.options.map(opt => `
                                    <button class="quiz-option-btn w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg border border-gray-600 transition-colors" data-option="${opt}">
                                        ${opt}
                                    </button>
                                `).join('')}
                            </div>
                            <p class="quiz-feedback text-sm mt-2 h-5"></p>
                        </div>
                    `;
                });
                quizHtml += '</div>';
                return quizHtml;
            }

            function attachQuizHandlers() {
                document.querySelectorAll('.quiz-option-btn').forEach(btn => {
                    btn.addEventListener('click', handleQuizOptionClick);
                });
            }

            function handleQuizOptionClick(event) {
                const selectedBtn = event.currentTarget;
                const questionEl = selectedBtn.closest('.quiz-question');
                const messageEl = selectedBtn.closest('[data-message-id]');
                const messageId = messageEl.dataset.messageId;
                const questionIndex = parseInt(questionEl.dataset.questionIndex, 10);
                
                if (!activeChat) return;

                const message = activeChat.history.find(m => m.id == messageId);
                const quizData = message.parts[0].text;
                const question = quizData[questionIndex];
                const selectedOption = selectedBtn.dataset.option;
                
                const isCorrect = selectedOption === question.answer;
                
                const feedbackEl = questionEl.querySelector('.quiz-feedback');
                if (isCorrect) {
                    selectedBtn.classList.add('correct');
                    feedbackEl.textContent = 'Correct!';
                    feedbackEl.classList.add('text-green-400');
                } else {
                    selectedBtn.classList.add('incorrect');
                    feedbackEl.textContent = `Wrong! The correct answer is ${question.answer}.`;
                    feedbackEl.classList.add('text-red-400');
                }

                questionEl.querySelectorAll('.quiz-option-btn').forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.option === question.answer) {
                        btn.classList.add('correct');
                    }
                });
            }

            function renderChatHistory() {
                chatHistoryList.innerHTML = '';
                allChats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = `group flex items-center justify-between p-2 rounded-lg text-sm chat-history-item ${activeChat?.id === chat.id ? 'active' : 'hover:bg-[#2a2b2c]'}`;
                    item.dataset.id = chat.id;

                    const titleButton = document.createElement('button');
                    titleButton.className = 'flex-grow text-left truncate';
                    titleButton.textContent = chat.title;
                    titleButton.onclick = () => handleSwitchChat(chat.id);
                    
                    const controls = document.createElement('div');
                    controls.className = 'hidden group-hover:flex items-center gap-1';

                    const renameBtn = document.createElement('button');
                    renameBtn.className = 'p-1 rounded hover:bg-gray-600';
                    renameBtn.innerHTML = '<i data-lucide="pencil" class="w-4 h-4"></i>';
                    renameBtn.onclick = (e) => { e.stopPropagation(); handleRenameChat(chat.id, item); };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'p-1 rounded hover:bg-gray-600';
                    deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
                    deleteBtn.onclick = (e) => { e.stopPropagation(); handleDeleteChat(chat.id); };

                    controls.appendChild(renameBtn);
                    controls.appendChild(deleteBtn);
                    item.appendChild(titleButton);
                    item.appendChild(controls);
                    chatHistoryList.appendChild(item);
                });
                lucide.createIcons();
            }
            
            async function handleRenameChat(id, itemElement) {
                const chat = allChats.find(c => c.id === id);
                if (!chat) return;

                const titleButton = itemElement.querySelector('button');
                const input = document.createElement('input');
                input.type = 'text';
                input.value = chat.title;
                input.className = 'bg-gray-700 text-white w-full rounded px-1 py-0 text-sm';
                
                titleButton.replaceWith(input);
                input.focus();
                input.select();
                
                const saveRename = async () => {
                    const newTitle = input.value.trim();
                    if (newTitle && newTitle !== chat.title) {
                        try {
                             await fetch(`${API_BASE_URL}/api/chats/${id}/rename`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${jwtToken}`
                                },
                                body: JSON.stringify({ title: newTitle })
                            });
                            chat.title = newTitle;
                            if (activeChat.id === id) chatTitleHeader.textContent = newTitle;
                        } catch(error) {
                            console.error("Rename failed:", error);
                        }
                    }
                    renderChatHistory();
                };

                input.addEventListener('blur', saveRename);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') saveRename();
                    else if (e.key === 'Escape') renderChatHistory();
                });
            }

            function handleDeleteChat(id) {
                showConfirmation('Delete Chat?', 'This action cannot be undone.', async () => {
                    try {
                        await fetch(`${API_BASE_URL}/api/chats/${id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${jwtToken}` }
                        });
                        allChats = allChats.filter(c => c.id !== id);
                        if (activeChat?.id === id) {
                            activeChat = null;
                            if (allChats.length > 0) {
                                await handleSwitchChat(allChats[0].id);
                            } else {
                                await handleNewChat();
                            }
                        }
                        renderChatHistory();
                    } catch(error) {
                        console.error("Delete failed:", error);
                    }
                });
            }

            function toggleLoading(show) {
                isLoading = show;
                submitButton.disabled = show;
                chatInput.disabled = show;
                const existingLoader = chatMessages.querySelector('.loader-container');
                if (show && !existingLoader) {
                    const loaderHtml = `<div class="flex items-start gap-4 max-w-4xl mx-auto loader-container"><div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm flex-shrink-0">AI</div><div class="bg-[#1e1f20] p-4 rounded-b-xl rounded-tr-xl flex-1"><div class="loader"></div></div></div>`;
                    chatMessages.insertAdjacentHTML('beforeend', loaderHtml);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                } else if (!show && existingLoader) {
                    existingLoader.remove();
                }
            }

            function handleClassChange(selectElement, genderDiv, streamDiv, genderInput, streamInput) {
                const value = parseInt(selectElement.value, 10);
                genderDiv.classList.toggle('hidden', value < 8);
                streamDiv.classList.toggle('hidden', value < 11);
                if (value < 8) genderInput.value = '';
                if (value < 11) streamInput.value = '';
            }

            function showConfirmation(title, text, onConfirm) {
                confirmTitle.textContent = title;
                confirmText.textContent = text;
                onConfirmCallback = onConfirm;
                confirmModal.classList.remove('hidden');
            }
            
            function autosizeTextarea() {
                chatInput.style.height = 'auto';
                chatInput.style.height = `${chatInput.scrollHeight}px`;
            }

            // --- Event Listeners ---
            authToggleBtn.addEventListener('click', toggleAuthMode);
            authForm.addEventListener('submit', handleAuthSubmit);
            chatForm.addEventListener('submit', handleChatSubmit);
            logoutBtn.addEventListener('click', showAuthScreen);
            sidebarToggleBtn.addEventListener('click', () => sidebar.classList.toggle('sidebar-hidden'));
            startChattingBtn.addEventListener('click', () => handleProfileSave(false));
            newChatBtn.addEventListener('click', handleNewChat);

            classGroupSelect.addEventListener('change', () => handleClassChange(classGroupSelect, genderSelectionDiv, streamSelectionDiv, genderSelect, streamSelect));
            classGroupSettings.addEventListener('change', () => handleClassChange(classGroupSettings, genderSelectionSettings, streamSelectionSettings, genderSettings, streamSettings));
            
            settingsOpenBtn.addEventListener('click', () => {
                if (userProfile) {
                    userNameSettingsInput.value = userProfile.name || '';
                    userAgeSettingsInput.value = userProfile.age || '';
                    classGroupSettings.value = userProfile.classValue || '';
                    genderSettings.value = userProfile.gender || '';
                    streamSettings.value = userProfile.stream || '';
                    handleClassChange(classGroupSettings, genderSelectionSettings, streamSelectionSettings, genderSettings, streamSettings);
                    settingsModal.classList.remove('hidden');
                }
            });
            
            settingsCloseBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
            settingsSaveBtn.addEventListener('click', () => handleProfileSave(true));
            
            aiToolsOpenBtn.addEventListener('click', () => {
                aiToolsModal.classList.remove('hidden');
                aiToolInputSection.classList.add('hidden');
                aiToolOptions.classList.remove('hidden');
                aiToolTopicInput.value = '';
            });

            aiToolOptions.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedAiTool = btn.dataset.tool;
                    aiToolOptions.classList.add('hidden');
                    aiToolInputSection.classList.remove('hidden');
                    aiToolTopicInput.focus();
                });
            });

            aiToolBackBtn.addEventListener('click', () => {
                aiToolInputSection.classList.add('hidden');
                aiToolOptions.classList.remove('hidden');
            });

            aiToolGenerateBtn.addEventListener('click', handleAiToolGeneration);
            
            confirmOkBtn.addEventListener('click', () => {
                if (onConfirmCallback) onConfirmCallback();
                confirmModal.classList.add('hidden');
            });

            confirmCancelBtn.addEventListener('click', () => {
                onConfirmCallback = null;
                confirmModal.classList.add('hidden');
            });

            chatInput.addEventListener('input', autosizeTextarea);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleChatSubmit(e);
                }
            });

            // --- Initial Load ---
            const token = localStorage.getItem('authToken');
            if (token) {
                jwtToken = token;
                showApp();
            }
            lucide.createIcons();
        });
    </script>
</body>
</html>
